name: Update README with Recent Repos

on:
  schedule:
    - cron: '0 0 * * *'  # 매일 자정(UTC) 실행
  push:
    branches: [main]
  workflow_dispatch:  # 수동 실행 가능

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update README
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Organization의 public repos 가져오기
            const { data: repos } = await github.rest.repos.listForOrg({
              org: 'pink-spider',
              type: 'public',
              sort: 'updated',
              direction: 'desc',
              per_page: 10
            });

            // .github repo 제외하고 최근 5개만
            const filteredRepos = repos
              .filter(repo => repo.name !== '.github')
              .slice(0, 5);

            // 테이블 생성
            let tableContent = '| Repository | Description | Updated |\n';
            tableContent += '|:-----------|:------------|:--------|\n';

            if (filteredRepos.length === 0) {
              tableContent += '| *아직 등록된 저장소가 없습니다* | | |\n';
            } else {
              for (const repo of filteredRepos) {
                const updatedAt = new Date(repo.updated_at);
                const now = new Date();
                const diffDays = Math.floor((now - updatedAt) / (1000 * 60 * 60 * 24));

                let timeAgo;
                if (diffDays === 0) timeAgo = '오늘';
                else if (diffDays === 1) timeAgo = '어제';
                else if (diffDays < 7) timeAgo = `${diffDays}일 전`;
                else if (diffDays < 30) timeAgo = `${Math.floor(diffDays / 7)}주 전`;
                else timeAgo = `${Math.floor(diffDays / 30)}개월 전`;

                const description = repo.description || '-';
                tableContent += `| [${repo.name}](${repo.html_url}) | ${description} | ${timeAgo} |\n`;
              }
            }

            // README 파일 읽기
            const readmePath = 'profile/README.md';
            let readme = fs.readFileSync(readmePath, 'utf8');

            // 마커 사이 내용 교체
            const startMarker = '<!-- REPOS_START -->';
            const endMarker = '<!-- REPOS_END -->';
            const regex = new RegExp(`${startMarker}[\\s\\S]*?${endMarker}`, 'g');

            readme = readme.replace(regex, `${startMarker}\n${tableContent}${endMarker}`);

            fs.writeFileSync(readmePath, readme);
            console.log('README updated successfully!');

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add profile/README.md
          git diff --quiet --staged || git commit -m "docs: update recent repositories list"
          git push
